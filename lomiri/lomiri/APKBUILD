# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20220112
_commit="decf11e1dfb2c089f8ab9076117558aa3ed4266b"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components lomiri-schemas suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor lomiri-keyboard"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock lomiri-indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev qtmir-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-Replace-own-lights-plugin-with-hfd-leds.patch
	0002-Replace-own-config-parser-with-libdeviceinfo.patch
	0003-NoDpkgParse.patch
	0004-Add-missing-includes.patch
	0005-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0006-Link-against-libintl.patch
	0007-No-systemd.patch
	0008-fixups.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel.1/
}

sha512sums="
347667236aa35182b1cba110e6257c669656f68c103b65f8a49697f9845a2079792af72e981ea77601525e3e08816137bd118b4ecb0ef1efdee0e7c7d67b157a  lomiri-decf11e1dfb2c089f8ab9076117558aa3ed4266b.tar.gz
cb0b2f4098e854b6208dc41a7594dcb82ea7e349fabbf9c4a10c107ad75bb10f230a1e6ef6c2236a5d44537f830f57921917c05446260be869c13fc1d6f2a74e  0001-Replace-own-lights-plugin-with-hfd-leds.patch
8c9b9e0640b36f94c1e665c67bbd2870db00c25b1f691aee483cbdd7ccec2c2d3defd2a1172c659137817cf02f261534f80a73df67880b473a666cbdee517106  0002-Replace-own-config-parser-with-libdeviceinfo.patch
96cce92bfacc07227204c698418ea72592324d2d1b7bff606b39304dbec44612e5611a26e58f1ce54f320544b0505d2046ff3da489cb848fe555522124474fe7  0003-NoDpkgParse.patch
709997032ef08cc2fb7b44e71eb4ccc038edb51e16c78fddec59309ef49a229c5eb27e57f495fd28d9c402f60723ae9be281917e3181692f928af38966d6b6d6  0004-Add-missing-includes.patch
be50b5d83d2e63c35c8fdbb3eaa8bdbf370c8dab42d604bb0db52a8678b367a69956cac2920511f1b694a0d1f643126443f866ed881b31edc3d10410265edc18  0005-Add-qt5-suffix-to-search-for-Qt-tools.patch
47cf610d9de5a4f574412a3d63d95a14bb92fb5ad7ee453f41c8e91d6375a6fb3b6e71521cc221a379c99fb093cf8b7df3b72f8e567bd375a329a060a0ee790f  0006-Link-against-libintl.patch
8ea69f8bfb5e6f828ade8d1670b8a579fb47fa6cb68fe18684d8a552fa4f2c9b831c896606367581feb10a23432dde0f3be4ef2c8c7466c8197f0d0fd475e6e3  0007-No-systemd.patch
cadf61d7679b316f54c4581738215e7dfe9752a79c4aa1f318ecbf66d6fe66aaa4e8621aa1c22a6c0456717b9dd7e4a6d784cf548e4345837caa68bd5a9a3897  0008-fixups.patch
"
