# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm/configs/cm_condor_defconfig

pkgname=linux-motorola-condor
pkgver=5.17
pkgrel=0
pkgdesc="Motorola Moto E (1st gen) kernel fork"
arch="armv7"
_carch="arm"
_flavor="motorola-condor"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="bash bc bison devicepkg-dev flex openssl-dev perl dtbtool coreutils xz"

# Source
_repository="linux"
_commit="573ad88c4c13e935e1e1e8e3e207ef0f47bc7ef4"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/pespin/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS" CONFIG_NO_ERROR_ON_MISMATCH=y

	# Master DTB (deviceinfo_bootimg_qcdt)
	dtbTool -p scripts/dtc/ -o "$_outdir/arch/$_carch/boot"/dt.img \
		"$_outdir/arch/$_carch/boot/"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor" "$_outdir"
	install -Dm644 "$_outdir/arch/$_carch/boot"/dt.img \
		"$pkgdir"/boot/dt.img
}

sha512sums="73d5cc572bac8330f86dc79c6c0b1a6ed9b3561ebe2b3fa7f8a75383c327d361ef198cbc9d6c4e6b8f8152a2d3e61c2479787b293e660c30f3af37332742c42a  linux-motorola-condor-573ad88c4c13e935e1e1e8e3e207ef0f47bc7ef4.tar.gz
22e2272a3217a8951c80c4bc66bb0818aca479c9c9c6e4fb4d5d9ad742a5a86af8feed375ea3cac75e7328234012dc385ecbac9b9188d0134f88ba3dda593f13  config-motorola-condor.armv7"
